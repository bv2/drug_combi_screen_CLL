---
title: "CLL drug combinations ex-vivo: Analyse combination effects"
author: "Britta Velten"
date: "1 Sept 2018"
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 3
---
#Introduction

This file analyses the data from the combination screen for combination with a second compound (drugC).

```{r, echo=F}
library(knitr )
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r, echo=F}
library(RColorBrewer)
library(Biobase)
library(abind)
library(grid)
library(gtable)
library(reshape2)
library(gridExtra)
require(pracma)
library(reshape2)
library(pheatmap)
library(magrittr)
library(lattice)
library(tidyverse)
```

```{r, echo=F}
today<-"180830"
setwd("~/Documents/cll/MarinaDrugComb/DrugCombi_Code4Ms/")
datadir <- "~/Documents/cll/MarinaDrugComb/rawData"
outdir <- "out"
figdir <- paste0("figuresCombi", today, "/")
if(!dir.exists(figdir)) dir.create(figdir)
knitr::opts_chunk$set(dev = c("png", "pdf"), fig.path = figdir)
```


#Data Import:  from DrugCombi_RawDataAnalysis.Rmd and molecular data about patients

```{r}
load(file.path(outdir, paste0("MarinaCombiDataAfterQC_",today,".RData")))
load(file.path(outdir, paste0("OmicsData",today,".RData")))
```

```{r, echo=FALSE}
# check consistency with old objects
old <- new.env()
load("../Analysis/DrugCombi_VisualisationData.RData", envir = old)

# same values in common columns added some more info on drugs removed well- or plate-wise info (misleading as only relevent for combination)
same_cols <- intersect(colnames(df4anaAvreplicatesRmOutliers), colnames(old$df4anaAvreplicatesRmOutliers))
setdiff(colnames(df4anaAvreplicatesRmOutliers), colnames(old$df4anaAvreplicatesRmOutliers))
setdiff(colnames(old$df4anaAvreplicatesRmOutliers),colnames(df4anaAvreplicatesRmOutliers))

# anti_join(x,y) keeps all rows of x that have no matching values in y
stopifnot(nrow(anti_join(old$df4anaAvreplicates, df4anaAvreplicates)) ==0)
stopifnot(nrow(anti_join(df4anaAvreplicates, old$df4anaAvreplicates)) ==0)
# all rows in old object are in new object
anti_join(old$df4anaAvreplicatesRmOutliers, df4anaAvreplicatesRmOutliers)
# 295 rows are additionally in new object because previously all values for drug-drug combination with outliers were removed
diff_df <- anti_join(df4anaAvreplicatesRmOutliers, old$df4anaAvreplicatesRmOutliers)

OutlierPoints <- filter(df4anaAvreplicates, effectB >1.4 | effectC >1.4 | effectBC>1.4)
stopifnot(nrow(df4anaAvreplicates) - nrow(df4anaAvreplicatesRmOutliers) ==nrow(OutlierPoints))

OutlierPoints <- select(OutlierPoints, PatientID, BDrugName, CDrugAbrv) %>%
  mutate(OutlierCombi=paste(PatientID, BDrugName, CDrugAbrv, sep="_"))
combi <- paste(df4anaAvreplicates$PatientID,df4anaAvreplicates$BDrugName, df4anaAvreplicates$CDrugAbrv, sep="_")
stopifnot(sum(combi %in% OutlierPoints$OutlierCombi) == nrow(df4anaAvreplicates) - nrow(df4anaAvreplicatesRmOutliers) + nrow(diff_df))
```

```{r}
# discard outliers for further analyses, only use averaged values for replicates
df4ana <- df4anaAvreplicatesRmOutliers
rm(df4anaAvreplicatesRmOutliers, df4anaAvreplicates)
```

# Add combination indices
```{r}
df4ana %<>% mutate(effectAdd = effectB * effectC)
```

#Plots

## Helper Functions for plots
Get legend from a ggplot object
```{r}
get_legend <- function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}
```


## Scatter Plots indivdual effect of base drug vs. combination
```{r}
BaseDrugs <- unique(df4ana$BDrugName)
CombiDrugs <- unique(df4ana$CDrugAbrv)
```

```{r BaseAloneVsCombi, eval=T, fig.height = 20, fig.width = 30}
BaseDrugs4paper <- 
for( drB in BaseDrugs){
  for( conc in paste0("c",1:5)){

  df4plot <- filter(df4ana, BDrugName==drB, BDrugConcId==conc)
  range = c(0, filter_th)

  gg <- ggplot(df4plot, aes(x=effectB, y=effectBC, color=PatientID))+
    geom_point(size=2, alpha=0.7)+
    geom_hline(aes(yintercept=0), colour="grey", linetype="dashed") +
    geom_vline(aes(xintercept=0), colour="grey", linetype="dashed") +
    scale_color_manual(values=patcol)+facet_wrap(~CDrugAbrv  , ncol=5) +
    geom_abline(intercept = 0, slope = 1, colour="black", linetype="solid") +
    ggtitle(paste("Base drug:", drB, conc))+ 
    coord_fixed() + scale_x_continuous(limits=range) + 
    scale_y_continuous( limits=range)+theme_bw() +
    xlab("viability - base drug") + ylab("viabiliy - drug combination") +
    guides(col=FALSE)
    
 print(gg)
  }
}
```


## Scatter Plots combined effect vs. additive effect
Included replicates
```{r, CombiVsAddEffect, fig.height = 10, fig.width = 30}
for( drB in BaseDrugs){
  for(drC in CombiDrugs){
      range = c(0, filter_th)
     df4plot <-  filter(df4ana, CDrugAbrv==drC, BDrugName==drB)
    gg <- ggplot(df4plot, aes(x=effectAdd, y=effectBC, color=PatientID))+
        geom_point(size=10, alpha=0.7)+
        geom_hline(aes(yintercept=0), colour="grey", linetype="dashed") +
        geom_vline(aes(xintercept=0), colour="grey", linetype="dashed") +
        scale_color_manual(values=patcol)+facet_wrap(~BDrugConcId  , ncol=5) +
        geom_abline(intercept = 0, slope = 1, colour="black", linetype="solid") +
        ggtitle(paste("Base drug:", drB, "Combination drug:", drC))+ 
        coord_fixed() + scale_x_continuous(limits=range) + 
        scale_y_continuous( limits=range)+theme_bw(base_size = 30)+
        theme(axis.text = element_text(size = 30), legend.text= element_text(size = 30))+
        scale_shape_manual(values=c(raw_1=16, censored_1=17,raw_2=1, censored_2=2))  +
       ylab("viability - measured drug combination")+xlab("viability - theoretical additive model")+
        # annotate("text", x=0.3, y=0.8, label= "antagonistic")+
        annotate("text", x=0.8, y=0.3, label= "synergy", size=9) + 
        guides(col=FALSE)
        #+ annotate("text", x=1, y=1, label= "additive")
    
 print(gg)
  }
}

```


## Curve over concentrations
```{r, echo=T}
source("plotThings.R")
```

Curve of combined effect over all concentrations of the base drug (solid) and curve of theoretical additive effect over all concentrations of the base drug (dashed)
```{r, eval=T}
plotThings("Curves", CombiDrugs=CombiDrugs,
                     BaseDrugs=BaseDrugs, df4anaAvreplicates=df4ana, outputdir=figdir)
```

## Area between curves of theoretical additive effect and true combined effect
```{r, eval=T}
# plotThings("ABC",CombiDrugs=CombiDrugs,
                     # BaseDrugs=BaseDrugs, df4anaAvreplicates=df4anaAvreplicates, outputdir=outputdir)


#direct
#for CombiDrugs
dfAggr<-select(df4anaAvreplicates,CDrugAbrv, BDrugName, PatientID, effectC) 
dfAggr<-dfAggr[!duplicated(dfAggr),]
dfAggr$ABC<-sapply(1:nrow(dfAggr), function(i){
dfidx<-dfAggr[i,] 
subDF<-df4anaAvreplicates  %>%  
  filter(CDrugAbrv==as.character(dfidx$"CDrugAbrv"),
         BDrugName==as.character(dfidx$"BDrugName"),
         PatientID==as.character(dfidx$"PatientID"))
#claculate area between the curves and normalize by highest concentration used
(-trapz(subDF$BDrugConc, subDF$effectB*subDF$effectC)-(-trapz(subDF$BDrugConc, subDF$effectBC)))/as.numeric(filter(DrugBase,Substance==dfidx$"BDrugName")[4]) #minus because concentrations ordered from high to low
}) 
dfAggr<-cbind(dfAggr,t(sapply(1:nrow(dfAggr), function(i){
dfidx<-dfAggr[i,] 
subDF<-df4anaAvreplicates  %>%  
  filter(CDrugAbrv==as.character(dfidx$"CDrugAbrv"),
         BDrugName==as.character(dfidx$"BDrugName"),
         PatientID==as.character(dfidx$"PatientID"))
effectB<-subDF$effectB
names(effectB)<-paste("effectB_",subDF$BDrugConcId, sep="")
effectB
}) ))
mini<-round(min(dfAggr$ABC))+1
maxi<-round(max(dfAggr$ABC))+1
maxiviab<-1.4
miniviab<-0

pdf(file.path(outputdir,"ABC_gg.pdf"), height=20, width=15)
for(drC in CombiDrugs){
  for(drB in BaseDrugs){
    subDF<-filter(dfAggr, CDrugAbrv==drC, BDrugName==drB)
    textsize<-18

ggABC<-ggplot(subDF, aes(y=ABC, x=reorder(PatientID,ABC), fill=PatientID))+geom_bar(stat="identity")+scale_fill_manual(values=patcol)+ggtitle(paste("SI of",drC, "with", drB))+xlab("Patient")+ theme(legend.position = "none")+ylab("SI")+
  geom_hline(aes(yintercept=median(subDF$ABC)))+coord_cartesian(ylim=c(mini, maxi))+ theme(axis.text.x = element_blank())+ theme(text = element_text(size = textsize))

ggCombiDrug<-ggplot(subDF, aes(y=effectC, x=reorder(PatientID,ABC), fill=PatientID, col=ifelse(effectC>maxiviab, "cutoff", "raw")))+ geom_bar(stat="identity")+scale_fill_manual(values=patcol)+scale_color_manual(values=c(cutoff="red",raw="black"))+ggtitle(paste("Single effect of", drC))+xlab("Patient")+ theme(legend.position = "none") + theme(axis.text.x = element_blank())+ theme(text = element_text(size = textsize))+ylab("viability of DMSO control")+coord_cartesian(ylim=c(miniviab, maxiviab))

gg_Basec1<-ggplot(subDF,aes(y=effectB_c1, x=reorder(PatientID,ABC), fill=PatientID, col=ifelse(effectB_c1>maxiviab, "cutoff", "raw")))+geom_bar(stat="identity")+scale_fill_manual(values=patcol)+ggtitle(paste("Single effect of", drB, ("c1")))+xlab("Patient")+ theme(legend.position = "none") + theme(axis.text.x = element_blank())+ theme(text = element_text(size = textsize))+ylab("viability of DMSO control")+coord_cartesian(ylim=c(miniviab, maxiviab))+scale_color_manual(values=c(cutoff="red",raw="black"))
gg_Basec2<-ggplot(subDF,aes(y=effectB_c2,  x=reorder(PatientID,ABC), fill=PatientID, col=ifelse(effectB_c2>maxiviab, "cutoff", "raw")))+geom_bar(stat="identity")+scale_fill_manual(values=patcol)+ggtitle(paste("Single effect of", drB, ("c2")))+xlab("Patient")+ theme(legend.position = "none") + theme(axis.text.x = element_blank())+ theme(text = element_text(size = textsize))+ylab("viability of DMSO control")+coord_cartesian(ylim=c(miniviab, maxiviab))+scale_color_manual(values=c(cutoff="red",raw="black"))
gg_Basec3<-ggplot(subDF,aes(y=effectB_c3,x=reorder(PatientID,ABC), fill=PatientID, col=ifelse(effectB_c3>maxiviab, "cutoff", "raw")))+geom_bar(stat="identity")+scale_fill_manual(values=patcol)+ggtitle(paste("Single effect of", drB, ("c3")))+xlab("Patient")+ theme(legend.position = "none") + theme(axis.text.x = element_blank())+ theme(text = element_text(size = textsize))+ylab("viability of DMSO control")+coord_cartesian(ylim=c(miniviab, maxiviab))+scale_color_manual(values=c(cutoff="red",raw="black"))
gg_Basec4<-ggplot(subDF,aes(y=effectB_c4,  x=reorder(PatientID,ABC), fill=PatientID, col=ifelse(effectB_c4>maxiviab, "cutoff", "raw")))+geom_bar(stat="identity")+scale_fill_manual(values=patcol)+ggtitle(paste("Single effect of", drB, ("c4")))+xlab("Patient")+ theme(legend.position = "none") + theme(axis.text.x = element_blank())+ theme(text = element_text(size = textsize))+ylab("viability of DMSO control")+coord_cartesian(ylim=c(miniviab, maxiviab))+scale_color_manual(values=c(cutoff="red",raw="black"))
gg_Basec5<-ggplot(subDF,aes(y=effectB_c5,  x=reorder(PatientID,ABC), fill=PatientID, col=ifelse(effectB_c5>maxiviab, "cutoff", "raw")))+geom_bar(stat="identity")+scale_fill_manual(values=patcol)+ggtitle(paste("Single effect of", drB, ("c5")))+xlab("Patient")+ theme(legend.position = "none") +theme(axis.text.x = element_text(angle = 90, hjust = 1))+ theme(text = element_text(size = textsize))+ylab("viability of DMSO control")+coord_cartesian(ylim=c(miniviab, maxiviab))+scale_color_manual(values=c(cutoff="red",raw="black"))

grid.arrange(ggABC, ggCombiDrug,gg_Basec1,gg_Basec2,gg_Basec3,gg_Basec4,gg_Basec5, nrow=4)
}}
dev.off()


```

## Difference between curves at the individual concentration values
```{r, eval=T}
CombiBenefitMeanDiff<-plotThings("DiffPerConc",CombiDrugs=CombiDrugs,
                     BaseDrugs=BaseDrugs, df4anaAvreplicates=df4anaAvreplicates, outputdir=outputdir)


#direct:
pdf(file.path(outputdir,"DiffPerConc_gg.pdf"), height=20, width=15)
for(drC in CombiDrugs){
  for(drB in BaseDrugs){
gg<-df4anaAvreplicates  %>%  filter(CDrugAbrv==drC, BDrugName==drB) %>%
mutate(effectthBC=effectB*effectC,deltaEffect=-effectBC+effectthBC)%>% 
ggplot(aes(x=PatientID, y=deltaEffect, fill=PatientID, group=BDrugConcId, col=BDrugConcId))+geom_bar(stat="identity", position="dodge")+scale_fill_manual(values=patcol)+coord_flip()+ggtitle(paste(drC, "with", drB))
print(gg)
} }               
dev.off()
```

## ABC median across Patients
needs some scaling to concentrations considered to be interpretable as a value
```{r, eval=T}
CombiBenefitABCMedian<-plotThings("CombiBenefit",CombiDrugs=CombiDrugs,
                     BaseDrugs=BaseDrugs, df4anaAvreplicates=df4anaAvreplicates, outputdir=outputdir)
write.csv(CombiBenefitABCMedian, file.path(outputdir,"ABCMedian.csv"))
```

# Calculate CI index accoridng to highest single agent and Bliss
Set CI to one if no effect of combination observed. ?
```{r}
df4CI<-mutate(df4anaAvreplicates,
              viabB=effectB,
              viabC=effectC,
              viabBC=effectBC,
              viabBper=effectB*100,
              viabCper=effectC*100,
              viabBCper=effectBC*100,
              thviabBC=viabB*viabC,
              thviabBCper=viabB*viabC*100,
              effectB=pmax(1-viabB,0),
              effectC=pmax(1-viabC,0),
              effectBC=pmax(1-viabBC,0))
df4CI<-mutate(df4CI,
              drBc=paste(BDrugName, BDrugConcId, sep="_"),
              CI_Bliss=ifelse(effectBC!=0,(effectB+effectC-effectB*effectC)/effectBC, 1) ,
              CI_HA=ifelse(effectBC!=0,pmax(effectB, effectC)/effectBC,1)
              )
df4CI<-mutate(df4CI, DiffAddSI=-viabBC+thviabBC)
#positive values indicate synergy (as measured viability lower than in an additive model)
write.csv(df4CI, file=file.path(outputdir,"Data4CI.csv"))
save(df4CI, file="df4CI.RData")
```

##Curves Single Agents, th. Combination and measured Combination

```{r}
pdf(file.path(outputdir,"CurvesSingleCombi.pdf"), width=15, height=18)
for(drC in unique(df4CI$CDrugAbrv)){
MedianDf4CI<-df4CI%>% filter(CDrugAbrv==drC) %>% 
  group_by( BDrugName, BDrugConcId) %>%
  dplyr::summarise(medianViabB=median(viabB),medianViabC=median(viabC),
                   medianViabBC=median(viabBC),medianthViabBC=median(thviabBC),
                   MADViabB=mad(viabB),MADViabC=mad(viabC),
                   MADViabBC=mad(viabBC), MADthViabBC=mad(thviabBC))
                                                                                            MedianDf4CI$BDrugConcId<-factor(MedianDf4CI$BDrugConcId, levels=rev(levels(MedianDf4CI$BDrugConcId)))          
                                                                                                      
gg<-ggplot(ungroup(MedianDf4CI), aes(x=BDrugConcId, group=BDrugName)) +
  geom_line(aes(y=medianViabBC, colour="BC"))+geom_point(aes(y=medianViabBC, colour="BC"))+geom_pointrange(aes(y=medianViabBC, ymin=medianViabBC-MADViabBC,ymax=medianViabBC+MADViabBC, colour="BC"))+
  geom_point(aes(y=medianViabB, colour="B"))+geom_line(aes(y=medianViabB, colour="B"))+geom_pointrange(aes(y=medianViabB, ymin=medianViabB-MADViabB,ymax=medianViabB+MADViabB, colour="B"))+
  geom_point(aes(y=medianViabC, colour="C"))+geom_line(aes(y=medianViabC, colour="C"))+geom_pointrange(aes(y=medianViabC, ymin=medianViabC-MADViabC,ymax=medianViabC+MADViabC, colour="C"))+
  geom_point(aes(y=medianthViabBC, colour="B*C"))+geom_line(aes(y=medianthViabBC, colour="B*C"))+geom_pointrange(aes(y=medianthViabBC,ymin=medianthViabBC-MADthViabBC,ymax=medianthViabBC+MADthViabBC, colour="B*C"))+
 ggtitle(drC)+facet_wrap(~BDrugName, ncol=5, scales="free_y")+xlab("concentration of base drug") +ylab("Median viability (fraction of control)")+
    theme_bw(base_size=18)#+scale_color_manual(values=brewer.pal(5,"Set1")[c(1:3,5)])
print(gg)
}
dev.off()
```

In percentage
```{r}
pdf(file.path(outputdir,"CurvesSingleCombiPerc.pdf"), width=15, height=18)
for(drC in unique(df4CI$CDrugAbrv)){
MedianDf4CI<-df4CI%>% filter(CDrugAbrv==drC) %>% 
  group_by( BDrugName, BDrugConcId) %>%
  dplyr::summarise(medianViabB=median(viabBper),medianViabC=median(viabCper),
                   medianViabBC=median(viabBCper),medianthViabBC=median(thviabBCper),
                   MADViabB=mad(viabBper),MADViabC=mad(viabCper),
                   MADViabBC=mad(viabBCper), MADthViabBC=mad(thviabBCper))
 MedianDf4CI$BDrugConcId<-factor(MedianDf4CI$BDrugConcId, levels=rev(levels(MedianDf4CI$BDrugConcId)))          
                                                                                                      
gg<-ggplot(ungroup(MedianDf4CI), aes(x=BDrugConcId, group=BDrugName)) +
  geom_line(aes(y=medianViabBC, colour="BC"))+geom_point(aes(y=medianViabBC, colour="BC"))+geom_pointrange(aes(y=medianViabBC, ymin=medianViabBC-MADViabBC,ymax=medianViabBC+MADViabBC, colour="BC"))+
  geom_point(aes(y=medianViabB, colour="B"))+geom_line(aes(y=medianViabB, colour="B"))+geom_pointrange(aes(y=medianViabB, ymin=medianViabB-MADViabB,ymax=medianViabB+MADViabB, colour="B"))+
  geom_point(aes(y=medianViabC, colour="C"))+geom_line(aes(y=medianViabC, colour="C"))+geom_pointrange(aes(y=medianViabC, ymin=medianViabC-MADViabC,ymax=medianViabC+MADViabC, colour="C"))+
  geom_point(aes(y=medianthViabBC, colour="B*C"))+geom_line(aes(y=medianthViabBC, colour="B*C"))+geom_pointrange(aes(y=medianthViabBC,ymin=medianthViabBC-MADthViabBC,ymax=medianthViabBC+MADthViabBC, colour="B*C"))+
 ggtitle(drC)+facet_wrap(~BDrugName, ncol=5, scales="free_y")+xlab("concentration of base drug") +ylab("Median viability (% of control)")+
    theme_bw(base_size=18)#+scale_color_manual(values=brewer.pal(5,"Set1")[c(1:3,5)])
print(gg)
}
dev.off()
```

##Highest single agent and Bliss Index
Concept of highes single agent: $CI=\frac{max(e_A, e_B)}{e_{AB}}$ with the effect e=1-viab
Calculate CI for each drug-drug combination, do it effect based (1-viability) and cut-off values below zero (no negative effects).
Concept of Bliss index $CI=\frac{e_A+ e_B-e_A*e_B)}{e_{AB}}$

###Per Patient and concentration
```{r}
pdf(file.path(outputdir,"CI_PerPatientAndConc.pdf"))
for(drC_idx in as.character(unique(df4CI$CDrugAbrv))){
  for(drBc_idx in unique(df4CI$drBc)){
    gg<-ggplot(dplyr::filter(df4CI, CDrugAbrv==drC_idx & drBc==drBc_idx) %>% melt(id.vars="PatientID", measure.vars = c("CI_HA","CI_Bliss")), aes(x=PatientID,y=value, fill=PatientID, color=variable))+geom_bar(position = "dodge", stat="identity")+scale_fill_manual(values=patcol)+scale_color_manual(values=c("black", "black"))+coord_flip()+
          ggtitle(paste("CI for", drC_idx, "and", drBc_idx)) +
          ylab("CI \n (CI<1 = synergy in the respective model)")+xlab("Patient")+geom_abline(colour="black",intercept=1, slope=0)+ theme(legend.position = "none")+facet_wrap(~variable)
    print(gg)
  }
}
dev.off()
```


###Summary across patients
```{r}
pdf(file.path(outputdir,"CI_AcrossPatPerConc.pdf"), height=30)
for(drC in unique(df4CI$CDrugAbrv)){
Summary_CI_Bliss<-df4CI%>%filter(CDrugAbrv==drC) %>% group_by( BDrugName, BDrugConcId)  %>% dplyr::summarise(mean=mean(CI_Bliss), median=median(CI_Bliss), vari=var(CI_Bliss), MAD=mad(CI_Bliss))
Summary_CI_HA<-df4CI %>%filter(CDrugAbrv==drC) %>% group_by( BDrugName, BDrugConcId)  %>% dplyr::summarise(mean=mean(CI_HA), median=median(CI_HA), vari=var(CI_HA), MAD=mad(CI_HA))

ggHA<-ggplot(Summary_CI_HA, aes(x=BDrugConcId, y=median, group=BDrugName))+geom_bar(position = "dodge", stat="identity")+geom_errorbar(aes(ymin=median-MAD, ymax=median+MAD))+facet_wrap(~BDrugName)+ylab("median CI_HA across patients")+xlab("base drug concentration")+ggtitle(paste("Highest Single Agent index for ", drC))+geom_abline(colour="red",intercept=1, slope=0)

ggBliss<-ggplot(Summary_CI_Bliss, aes(x=BDrugConcId, y=median, group=BDrugName))+geom_bar(position = "dodge", stat="identity")+geom_errorbar(aes(ymin=median-MAD, ymax=median+MAD))+facet_wrap(~BDrugName)+ylab("median CI_Bliss across patients")+xlab("base drug")+ggtitle(paste("Bliss index for ", drC))+geom_abline(colour="red",intercept=1, slope=0)

grid.arrange(ggBliss, ggHA)
}
dev.off()
```




#Heatmap combination
Draw a heatmap of the area between curves (normalized by highest concentration used), red means more than additive (i.e. true viability curve of combination is below additive model curve) and blue means less than additive (i.e. true viability curve of combination is above additive model curve).
```{r}
DrugByDrugMatrixMean<-do.call(cbind, CombiBenefitMeanDiff)
pheatmap(DrugByDrugMatrixMean, clustering_distance_rows="correlation",
         clustering_distance_cols="correlation")
```

Concentration mean of Patient Median of DiffPerConc
```{r}
DrugByDrugMatrixABC<-do.call(cbind, CombiBenefitABCMedian)
pheatmap(DrugByDrugMatrixABC)
#remove IPI145
# ipi145IDX<-which(rownames(DrugByDrugMatrixABC)=="IPI-145")
ipi145IDY<-which(colnames(DrugByDrugMatrixABC)=="IPI145")
DrugByDrugMatrixABC<-DrugByDrugMatrixABC[,-ipi145IDY]

#remove IPI145
# ipi145IDX<-which(rownames(DrugByDrugMatrixMean)=="IPI-145")
ipi145IDY<-which(colnames(DrugByDrugMatrixMean)=="IPI145")
DrugByDrugMatrixMean<-DrugByDrugMatrixMean[,-ipi145IDY]

pdf(file.path(outputdir, "HeatmapSynergyDrugByDrug.pdf"))
pheatmap(DrugByDrugMatrixABC, main = "Based on normalized area between \n viability curve of drug combination \n and theoretical additive viability curve \n (positive values=more than additive, \n negative values= less than additive)", clustering_distance_rows="correlation",
         clustering_distance_cols="correlation")
pheatmap(DrugByDrugMatrixMean, main = "Based on mean difference across conentrations \n between viability median across patients of drug combination \n and theoretical additive model \n (positive values=more than additive, \n negative values= less than additive)", clustering_distance_rows="correlation",
         clustering_distance_cols="correlation")
dev.off()

# pdf(file.path(outputdir, "HeatmapSynergyDrugByDrug_zscore.pdf"))
# DrugByDrugMatrixABC_sc<-apply(DrugByDrugMatrixABC,2,scale)
# rownames(DrugByDrugMatrixABC_sc)<-rownames(DrugByDrugMatrixABC)
# pheatmap(DrugByDrugMatrixABC_sc, main = "Z-scores of normalized area between \n viability curve of drug combination \n and theoretical additive viability curve \n (positive values=more than additive, \n negative values= less than additive)", clustering_distance_rows="correlation",
#          clustering_distance_cols="correlation")
# DrugByDrugMatrixMean_sc<-apply(DrugByDrugMatrixMean,2,scale)
# rownames(DrugByDrugMatrixMean_sc)<-rownames(DrugByDrugMatrixMean)
# pheatmap(DrugByDrugMatrixMean_sc, main = "Z-scores of mean difference across conentrations \n between viability median across patients of drug combination \n and theoretical additive model \n (positive values=more than additive, \n negative values= less than additive)", clustering_distance_rows="correlation",
#          clustering_distance_cols="correlation")
# dev.off()
```

#Heatmap Base-DrugxDrug and PatientxDrugs
```{r}
dftmp<-select(df4anaAvreplicates, effectB, BDrugName, BDrugConcId,PatientID, CDrugID )
dftmp$Bid<-paste(dftmp$BDrugName, dftmp$BDrugConcId, sep="_")
matrixBxP<-matrix(NA, ncol=length(unique(dftmp$Bid)), nrow=length(unique(dftmp$PatientID)))
colnames(matrixBxP)<-unique(dftmp$Bid)
rownames(matrixBxP)<-unique(dftmp$PatientID)
for( drB in unique(dftmp$Bid)) {
  tmpB<-filter(dftmp, Bid==drB)
  select(tmpB, -CDrugID)[!duplicated(select(tmpB, -CDrugID)),]
  matrixBxP[as.character(tmpB$PatientID),drB]<-tmpB$effectB
}
#remove patients with NAs (in at least on screen outliers)
matrixBxP<-matrixBxP[apply(matrixBxP,1,function(r) !any(is.na(r))),]
pdf(file.path(outputdir, "HeatmapBaseDrugByPatients_cor.pdf"), width=30, height=30, onefile=FALSE)
pheatmap(matrixBxP, main = "Normalized viabilty of base drugs", clustering_distance_rows="correlation",
         clustering_distance_cols="correlation",
         color = colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(140),
         breaks=seq(0,1.4,0.01)
)
dev.off()

pdf(file.path(outputdir, "HeatmapBaseDrugByPatients_zscore.pdf"), width=30, height=30, onefile=FALSE)
Z_matrixBxP<-apply(matrixBxP,2,scale)
rownames(Z_matrixBxP)<-rownames(matrixBxP)
pheatmap(Z_matrixBxP, main = "Z-score normalized viabilty of base drugs", clustering_distance_rows="correlation",
         clustering_distance_cols="correlation")
dev.off()

pdf(file.path(outputdir, "HeatmapBaseDrugByDrug.pdf"), width=30, height=30, onefile=FALSE)
pheatmap(cor(matrixBxP), main = "Normalized viabilty of base drugs", clustering_distance_rows="correlation",
         clustering_distance_cols="correlation")
dev.off()

```

#Comparions BCR inhibitors
Scatterplots comparing the effect of 2 BCR inhibitors across all base drugs
```{r}
PlotComparsionCombiCDrugs <- function(CDrugAbrv.x, CDrugAbrv.y, range = c(0,1.25)){
df.x<-filter(df4anaAvreplicates, CDrugAbrv==CDrugAbrv.x)
df.y<-filter(df4anaAvreplicates, CDrugAbrv==CDrugAbrv.y)
df<-merge(df.x, df.y, by=c("PatientID","BDrugID", "BDrugConcId",
                                               "BDrugConc", "BDrugName"))
effect.x<-df$effectBC.x
effect.y<-df$effectBC.y

filename<-paste("ComparisonCombi", CDrugAbrv.x, CDrugAbrv.y,".pdf", sep="_")
  pdf(file.path(outputdir, filename), width=10, height=12)
  df$cens.x<-ifelse(effect.x<range[1], range[1], ifelse(effect.x>range[2], range[2], effect.x))
  df$cens.y<-ifelse(effect.y<range[1], range[1], ifelse(effect.y>range[2], range[2], effect.y))
  df$shape<-ifelse(df$cens.x!=effect.x | df$cens.y!=effect.y, "censored", "uncensored")

  gg1<-ggplot(df, aes(x=cens.x, y=cens.y, col=BDrugName, shape=shape))+geom_point()+xlab(paste("Combination effect with", CDrugAbrv.x, "\n (viability relative to DMSO control)"))+ylab(paste("Combination effect with", CDrugAbrv.y, "\n (viability relative to DMSO control)"))+    scale_shape_manual(values=c(censored=2, uncensored=19)) + annotate("text", x=range[1]+0.1, y=range[2]-0.1, label=paste("rho^2 ==", (round(cor(df$effectBC.x,df$effectBC.y)^2,2))), parse=T)

  print(gg1)
  
  gg2<-ggplot(df, aes(x=cens.x, y=cens.y, col=BDrugName, shape=shape))+geom_point()+
    xlab("Combination effect with Ibrutinib100 \n (viability relative to DMSO control)")+
    ylab("Combination effect with CAL-101 \n (viability relative to DMSO control)")+
    facet_wrap(~BDrugName)+    scale_shape_manual(values=c(censored=2, uncensored=19))+
    annotate("text", x=range[1]+0.3, y=range[2]-0.1, label=paste("rho^2 ==", (round(dplyr::summarize(group_by(df, BDrugName), cor=cor(effectBC.x, effectBC.y))$cor,2))), parse=T, size=3) +guides(col=guide_legend(ncol=1)) + geom_abline(slope=1, intercept=0)
  print(gg2)
  #remove outliers higher than 2
  # df_remOutlier<-df[df$effectBC.x<2 & df$effectBC.y<2,]
  df_remOutlier<-df
  df_directcomp<-data.frame(effect=c(df_remOutlier$effectBC.x,
                                     df_remOutlier$effectBC.y),
                            drug=c(as.character(df_remOutlier$CDrugAbrv.x),
                                   as.character(df_remOutlier$CDrugAbrv.y)))
  median<-df_directcomp%>%group_by(drug)%>% dplyr::summarise(median(effect))
  t.out<-t.test(df_directcomp$effect ~ df_directcomp$drug, var.equal=TRUE)
  
gg3<-ggplot(df_directcomp, aes(x=drug, y=effect))+geom_point(position="jitter", alpha=0.4, col="forestgreen")+geom_boxplot(alpha=0.4) + annotate("text", label=paste("p=",round(t.out$p.value,3)), x = 1.5, y = 2, size = 4)+ annotate("text", label=paste("median=",as.numeric(median[1,2])), x = 1, y = 1.5, size = 4)+ annotate("text", label=paste("median=", as.numeric(median[2,2])), x = 2, y = 1.5, size = 4)
print(gg3)

dev.off()
}
  
```

```{r}
PlotComparsionSingleCDrugs<-function(CDrugAbrv.x, CDrugAbrv.y, range = c(0,1.25)){
df.x<-filter(df4anaAvreplicates, CDrugAbrv==CDrugAbrv.x)
df.y<-filter(df4anaAvreplicates, CDrugAbrv==CDrugAbrv.y)
df<-merge(df.x, df.y, by=c("PatientID","BDrugID", "BDrugConcId",
                                               "BDrugConc", "BDrugName"))
df<-select(df, PatientID, CDrugAbrv.x, CDrugAbrv.y, CDrugID.x, CDrugID.y, CDrugConc.x,CDrugConc.y, effectC.x,effectC.y )
df<-distinct(df)
effect.x<-df$effectC.x
effect.y<-df$effectC.y

# filename<-paste("ComparisonSingle", CDrugAbrv.x, CDrugAbrv.y,".pdf", sep="_")
  # pdf(file.path(outputdir, filename), width=7, height=7)
  df$cens.x<-ifelse(effect.x<range[1], range[1], ifelse(effect.x>range[2], range[2], effect.x))
  df$cens.y<-ifelse(effect.y<range[1], range[1], ifelse(effect.y>range[2], range[2], effect.y))
  df$shape<-ifelse(df$cens.x!=effect.x | df$cens.y!=effect.y, "censored", "uncensored")

  gg1<-ggplot(df, aes(x=cens.x, y=cens.y,shape=shape))+geom_point()+
    xlab(paste("Single effect of", CDrugAbrv.x, "\n (viability relative to DMSO control)"))+
    ylab(paste("Single effect of", CDrugAbrv.y, "\n (viability relative to DMSO control)"))+
    scale_shape_manual(values=c(censored=2, uncensored=19)) + 
    annotate("text", x=range[1]+0.2, y=range[2]-0.1, 
             label=paste("rho^2 ==", (round(cor(df$effectC.x,df$effectC.y)^2,2))), parse=T)+ scale_x_continuous(limits=range) + 
    scale_y_continuous( limits=range) +ggtitle(paste("Comparison of single effect of", CDrugAbrv.x, "and", CDrugAbrv.y, sep=" "))

  print(gg1)
  
  # dev.off()
}
  
```


```{r}
PlotComparsionCombiCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "CAL101", range = c(0,1.2))
PlotComparsionCombiCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "Ibrutinib10", range = c(0,1.2))
PlotComparsionCombiCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "AVL292", range = c(0,1.2))
PlotComparsionCombiCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "R406", range = c(0,1.2))
PlotComparsionCombiCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "IPI145", range = c(0,1.2))
```

```{r}
pdf(file.path(outputdir,"ComparisonBCRSingle.pdf"))
PlotComparsionSingleCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "CAL101", range = c(0,1.2))
PlotComparsionSingleCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "Ibrutinib10", range = c(0,1.2))
PlotComparsionSingleCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "AVL292", range = c(0,1.2))
PlotComparsionSingleCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "R406", range = c(0,1.2))
PlotComparsionSingleCDrugs(CDrugAbrv.x="Ibrutinib100", CDrugAbrv.y = "IPI145", range = c(0,1.2))
dev.off()
```

Heatmap of combination effects with idelalisib and ibrutinib with only common patients (use Ibrutinib100 as more patients available)
```{r}
df.x<-filter(df4anaAvreplicates, CDrugAbrv=="Ibrutinib100")
df.y<-filter(df4anaAvreplicates, CDrugAbrv=="CAL101")
df<-merge(df.x, df.y, by=c("PatientID","BDrugID", "BDrugConcId",
                                               "BDrugConc", "BDrugName"))
df$BDrug<-paste(df$BDrugName, df$BDrugConcId, sep="_")

dfIbru<-select(df, BDrug, effectBC.x, PatientID)
df4melt<-select(df,PatientID,BDrug, effectBC.x )
matIbru<-melt(df4melt,id.vars=c("PatientID", "BDrug"), measure.vars = "effectBC.x") %>%
  acast(PatientID~BDrug)

dfIdea<-select(df, BDrug, effectBC.y, PatientID)
df4melt<-select(df,PatientID,BDrug, effectBC.y )
matIdea<-melt(df4melt,id.vars=c("PatientID", "BDrug"), measure.vars = "effectBC.y") %>%
  acast(PatientID~BDrug)

#remove Na (patients being outlier in at least one screen)
noOutl<-apply(matIbru,1,function(r) !any(is.na(r))) &apply(matIdea,1,function(r) !any(is.na(r)))
matIbru<-matIbru[noOutl,]
matIdea<-matIdea[noOutl,]

pdf(file.path(outputdir,"HeatmapPatbyDrug_IbruVsIdea.pdf"), width=20, height = 15)
pheatmap(matIbru, color = colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(140),
              clustering_distance_rows="correlation", 
              clustering_distance_cols="correlation",
              main=paste("viabilty values for combination with Ibrutinib100"),
              breaks=seq(0,1.4,0.01),
              silent=F, fontsize = 18, fontsize_col = 10,fontsize_row = 16)

pheatmap(matIdea, color = colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(140),
              clustering_distance_rows="correlation", 
              clustering_distance_cols="correlation",
              main=paste("viabilty values for combination with CAL-101"),
              breaks=seq(0,1.4,0.01),
              silent=F, fontsize = 18, fontsize_col = 10,fontsize_row = 16)
dev.off()

#correlation between two base drugs across all patients for comnination effect with Ibrutinib or Idelalisib
corIdea<-cor(matIdea)
corIbru<-cor(matIbru)
pdf(file.path(outputdir,"HeatmapDrugCor_IbruVsIdeal.pdf"), width=15, height = 15)
pheatmap(corIdea, main="Correlation of viability values across patients for combination with CAL-101")
pheatmap(corIbru, main="Correlation of viability values across patients for combination with Ibrutinib100")

orderIbru<-hclust(dist(corIbru))$order
corCombiIdea<-corIdea[orderIbru,orderIbru] 
corCombiIdea[lower.tri(corCombiIdea, diag = F)]<-0

corCombiIbru<-corIbru[orderIbru,orderIbru] 
corCombiIbru[upper.tri(corCombiIbru, diag = F)]<-0
corCombi<-corCombiIdea+corCombiIbru
diag(corCombi)<-1

pheatmap(corCombi, cluster_rows = F, cluster_cols =F, main="Correlation of viability values across patients for Ibrutinib (lower triangle) and CAL-101 (upper triangle)")
dev.off()
```


Heatmap of combination effects with AVL292 and ibrutinib with only common patients (use Ibrutinib100 as more patients available)
```{r}
df.x<-filter(df4anaAvreplicates, CDrugAbrv=="Ibrutinib100")
df.y<-filter(df4anaAvreplicates, CDrugAbrv=="AVL292")
df<-merge(df.x, df.y, by=c("PatientID","BDrugID", "BDrugConcId",
                                               "BDrugConc", "BDrugName"))
df$BDrug<-paste(df$BDrugName, df$BDrugConcId, sep="_")

dfIbru<-select(df, BDrug, effectBC.x, PatientID)
df4melt<-select(df,PatientID,BDrug, effectBC.x )
matIbru<-melt(df4melt,id.vars=c("PatientID", "BDrug"), measure.vars = "effectBC.x") %>%
  acast(PatientID~BDrug)

dfAVL<-select(df, BDrug, effectBC.y, PatientID)
df4melt<-select(df,PatientID,BDrug, effectBC.y )
matAVL<-melt(df4melt,id.vars=c("PatientID", "BDrug"), measure.vars = "effectBC.y") %>%
  acast(PatientID~BDrug)

#remove Na (patients being outlier in at least one screen)
noOutl<-apply(matIbru,1,function(r) !any(is.na(r))) &apply(matAVL,1,function(r) !any(is.na(r)))
matIbru<-matIbru[noOutl,]
matAVL<-matAVL[noOutl,]

pdf(file.path(outputdir,"HeatmapPatbyDrug_IbruVsAVL.pdf"), width=20, height = 15)
pheatmap(matIbru, color = colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(140),
              clustering_distance_rows="correlation", 
              clustering_distance_cols="correlation",
              main=paste("viabilty values for combination with Ibrutinib100"),
              breaks=seq(0,1.4,0.01),
              silent=F, fontsize = 18, fontsize_col = 10,fontsize_row = 16)

pheatmap(matAVL, color = colorRampPalette(rev(brewer.pal(n = 7, name ="RdYlBu")))(140),
              clustering_distance_rows="correlation", 
              clustering_distance_cols="correlation",
              main=paste("viabilty values for combination with CAL-101"),
              breaks=seq(0,1.4,0.01),
              silent=F, fontsize = 18, fontsize_col = 10,fontsize_row = 16)
dev.off()

#correlation between two base drugs across all patients for comnination effect with Ibrutinib or AVL
corAVL<-cor(matAVL)
corIbru<-cor(matIbru)
pdf(file.path(outputdir,"HeatmapDrugCor_IbruVsAVL.pdf"), width=15, height = 15)
pheatmap(corAVL, main="Correlation of viability values across patients for combination with AVL")
pheatmap(corIbru, main="Correlation of viability values across patients for combination with Ibrutinib100")

orderIbru<-hclust(dist(corIbru))$order
corCombiAVL<-corAVL[orderIbru,orderIbru] 
corCombiAVL[lower.tri(corCombiAVL, diag = F)]<-0

corCombiIbru<-corIbru[orderIbru,orderIbru] 
corCombiIbru[upper.tri(corCombiIbru, diag = F)]<-0
corCombi<-corCombiAVL+corCombiIbru
diag(corCombi)<-1

pheatmap(corCombi, cluster_rows = F, cluster_cols =F, main="Correlation of viability values across patients for Ibrutinib (lower triangle) and AVL (upper triangle)")
dev.off()
```

#SessionInfo
```{r}
sessionInfo()
```

